---
title: Автоматическое резервное копирование
---


# Создание резервных копий

С помощью этой инструкции вы сможете автоматически создавать резервные копии важных файлов Marzban, которые находятся в двух директориях: `/opt/marzban/` и `/var/lib/marzban/`, чтобы избежать проблем в случае сбоя или переноса панели.


## Настройка автоматического резервного копирования

### Шаг первый

Выполните следующий скрипт, чтобы получить все команды Marzban.
```bash
sudo bash -c "$(curl -sL https://github.com/Gozargah/Marzban-scripts/raw/master/marzban.sh)" @ install-script
```

### Шаг второй

Для настройки сервиса резервного копирования Marzban введите следующую команду.
```bash
marzban backup-service
```

::: tip Примечание
Обязательно выполняйте эту команду от имени пользователя `root`.
:::

### Шаг третий

Затем вас попросят ввести токен бота. Вам нужно создать бота через [BotFather](https://t.me/BotFather) и ввести полученный токен.

### Шаг четвертый

Затем вас попросят ввести ID чата. Чтобы получить ID чата или канала, который вы выделили для получения резервных копий, вам нужно переслать сообщение от себя или канала боту [UserInfoBot](https://t.me/userinfobot), который отправит вам ID чата.

### Шаг пятый

На этом этапе для определения времени, когда бот будет отправлять вам резервную копию, вам нужно ввести число от `1` до `24` для настройки cron-задания. Например, если вы введете `2`, то будете получать резервную копию в телеграм-боте каждые `2` часа.

::: tip Примечание
Время отправки резервной копии будет основано на времени сервера.
:::

::: tip Примечание
Для изменения времени отправки, изменения ID чата или удаления сервиса резервного копирования снова введите следующую команду.

```bash
marzban backup-service
```

Первый вариант - для применения изменений с начала, второй - для удаления сервиса резервного копирования.
:::

## Создание мгновенной резервной копии

Если вы уже настроили сервис резервного копирования Marzban, то при вводе следующей команды вы сразу получите резервную копию в телеграм-боте, а также копия zip-файла будет сохранена в директории `/opt/marzban/backup`. Однако, если вы не настроили сервис резервного копирования, мгновенная резервная копия будет сохранена только как zip-файл в указанной директории.

```bash
marzban backup
```

::: tip Примечание
Обратите внимание, что если вы уже создали мгновенную резервную копию и делаете это во второй раз, вторая резервная копия заменит предыдущую, и предыдущий файл будет удален.
:::

## Восстановление из резервной копии

Если вы хотите перенести панель Marzban или по какой-либо причине ваша панель столкнулась с проблемами, с помощью инструкции ниже вы можете восстановить свою резервную копию. Метод зависит от типа вашей базы данных. По умолчанию база данных панели Marzban - SQLite, но если вы следовали инструкции [Настройка MySQL](https://gozargah.github.io/marzban/examples/mysql), метод восстановления базы данных будет немного отличаться.

::: tip Примечание
Восстановление резервной копии базы данных MariaDB аналогично восстановлению базы данных MySQL.
:::

## Восстановление резервной копии базы данных SQLite 

Важные файлы Marzban находятся в двух директориях: `/opt/marzban/` и `/var/lib/marzban/`. Для базы данных SQLite сначала нужно установить Marzban на новый сервер, затем просто заменить папки Marzban в указанных директориях, после чего перезапустить Marzban следующей командой для восстановления резервной копии.

```bash
marzban restart
```

## Восстановление резервной копии базы данных MySQL через PhpMyAdmin (первый метод)


Для восстановления резервной копии базы данных MySQL действуйте точно так же, как описано выше для базы данных SQLite, с той разницей, что файл SQL нужно восстановить через панель управления базой данных PhpMyAdmin. Если вы установили панель Marzban на новый сервер, сначала нужно изменить базу данных на MySQL.

Для этого удалите папку mysql на новом сервере, которая находится в `/var/lib/marzban/mysql`, чтобы после перезапуска Marzban папка и файлы внутри нее были созданы заново. Затем перейдите в панель управления базой данных PhpMyAdmin, которая по умолчанию доступна по адресу `IP:8010`.

::: tip Примечание 
Чтобы панель управления базой данных PhpMyAdmin была доступна, вы должны сначала активировать ее согласно инструкции по настройке MySQL.
:::

В меню слева выберите `marzban`, затем выберите флажок `Check all`, затем в правой части, которая называется `With selected:`, выберите опцию `drop`, затем нажмите `Yes`. Теперь база данных MySQL пуста, и вы можете восстановить свой файл резервной копии SQL.

В верхней части страницы нажмите `Import`, затем в разделе `File to import:` нажмите на `Browse` и выберите свой SQL-файл, затем нажмите кнопку `Import` в конце страницы и подождите несколько секунд. Если вы все сделали правильно, вы должны увидеть зеленое сообщение `Import has been successfully finished.`. Наконец, перезапустите Marzban следующей командой.

```bash
marzban restart
```
Теперь ваша резервная копия успешно восстановлена.

::: tip Примечание 
Если вы поместите файл `SQL` в файл `Zip` перед импортом в панель управления базой данных `PhpMyAdmin`, скорость восстановления будет выше.
:::

## Восстановление резервной копии базы данных MySQL через Terminal (второй метод)

Если вы хотите восстановить резервную копию базы данных `MySQL` через терминал сервера без использования `PhpMyAdmin`, этот метод подходит для вас. Сначала вам нужно загрузить файл резервной копии `SQL` на ваш сервер, затем в терминале сервера введите следующую команду, заменив переменные. Замените переменную `DB_PASSWORD` на пароль вашей базы данных. Замените переменную `SQL_BACKUP_ADDRESS` на адрес файла резервной копии `SQL`. Затем введите команду.
```
docker exec -i marzban-mysql-1 mysql -u root -p"DB_PASSWORD" marzban < "SQL_BACKUP_ADDRESS"
```

После этого шага необходимо перезапустить Marzban следующей командой.

```bash
marzban restart
```
Теперь ваша резервная копия успешно восстановлена.


::: warning Внимание
Если вы использовали автоматический скрипт резервного копирования для базы данных `SQLite`, после миграции на базу данных `MySQL` вам нужно снова запустить скрипт, так как процесс создания резервных копий для этих двух баз данных отличается.
:::
